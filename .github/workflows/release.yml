name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout NextUI (build dependencies)
        uses: actions/checkout@v4
        with:
          repository: mohammadsyuhada/NextUI
          path: NextUI

      - name: Checkout Music Player
        uses: actions/checkout@v4
        with:
          path: NextUI/workspace/nextui-music-player

      - name: Build for tg5040
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/NextUI/workspace:/root/workspace \
            ghcr.io/loveretro/tg5040-toolchain:latest \
            /bin/bash -c 'source ~/.bashrc && cd /root/workspace/tg5040/libmsettings && make build CROSS_COMPILE=aarch64-nextui-linux-gnu- PREFIX=/opt/nextui PREFIX_LOCAL=/opt/nextui && cd /root/workspace/nextui-music-player/src && make PLATFORM=tg5040'

      - name: Build for tg5050
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/NextUI/workspace:/root/workspace \
            ghcr.io/loveretro/tg5040-toolchain:latest \
            /bin/bash -c 'source ~/.bashrc && cd /root/workspace/tg5050/libmsettings && make build CROSS_COMPILE=aarch64-nextui-linux-gnu- PREFIX=/opt/nextui PREFIX_LOCAL=/opt/nextui && cd /root/workspace/nextui-music-player/src && make PLATFORM=tg5050'

      - name: Package release zip
        run: |
          cd ${{ github.workspace }}/NextUI/workspace/nextui-music-player
          mkdir -p "Music Player.pak/bin/tg5040" "Music Player.pak/bin/tg5050"
          cp launch.sh "Music Player.pak/"
          cp pak.json "Music Player.pak/"
          cp bin/keyboard bin/wget bin/yt-dlp "Music Player.pak/bin/"
          cp bin/tg5040/musicplayer.elf "Music Player.pak/bin/tg5040/"
          cp bin/tg5050/musicplayer.elf "Music Player.pak/bin/tg5050/"
          cp -r res "Music Player.pak/"
          cp -r state "Music Player.pak/"
          cp -r stations "Music Player.pak/"
          zip -r "Music.Player.pak.zip" "Music Player.pak"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd ${{ github.workspace }}/NextUI/workspace/nextui-music-player
          VERSION=${GITHUB_REF#refs/tags/}
          gh release create "$VERSION" \
            --title "$VERSION" \
            --generate-notes \
            "Music.Player.pak.zip"
